{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'hello_world/css/main.css' %}">

<div class="zendenta-dashboard d-flex min-vh-100">
  <!-- Sidebar -->
  <aside class="zendenta-sidebar d-flex flex-column align-items-center py-4 shadow-lg glassy-toolbar position-relative">
    <div class="sidebar-logo mb-4 position-relative">
      <img src="{% static 'hello_world/images/icon.gif' %}" alt="Logo nhỏ" class="logo-sidebar rounded-circle shadow">
    </div>
    <nav class="sidebar-nav w-100">
      <ul class="nav flex-column gap-3 align-items-center">
        <li class="nav-item w-100">
          <a class="nav-link sidebar-link d-flex flex-column align-items-center justify-content-center p-2 rounded-3 {% if request.path == '/apps/hello-world/' or request.path == '/apps/hello-world' %}active{% endif %}" href="{% url 'hello_world:home' %}" title="Trang chủ">
            <i class="bi bi-house-door fs-3"></i>
            <span class="small mt-1">Trang chủ</span>
          </a>
        </li>
        <li class="nav-item w-100">
          <a class="nav-link sidebar-link d-flex flex-column align-items-center justify-content-center p-2 rounded-3 {% if request.path == '/apps/hello-world/model-list/' %}active bg-primary text-white shadow{% endif %}" href="{% url 'hello_world:model_list' %}" title="Quản lý mô hình">
            <i class="bi bi-list-task fs-3"></i>
            <span class="small mt-1">Mô hình</span>
          </a>
        </li>
        <li class="nav-item w-100">
          <a class="nav-link sidebar-link d-flex flex-column align-items-center justify-content-center p-2 rounded-3" id="sidebar-map-link" href="#" title="Bản đồ">
            <i class="bi bi-geo-alt fs-3"></i>
            <span class="small mt-1">Bản đồ</span>
          </a>
        </li>
        <li class="nav-item w-100">
          <button id="function-btn" class="btn btn-primary d-flex flex-column align-items-center justify-content-center p-2 rounded-3 w-100" >
            <i class="bi bi-gear fs-3"></i>
            <span class="small mt-1">Chức năng</span>
          </button>
        </li>
      </ul>
    </nav>
    <!-- User avatar & dropdown -->
    <div class="sidebar-user mt-auto mb-2 w-100 d-flex flex-column align-items-center">
      <div class="dropdown w-100 d-flex flex-column align-items-center">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle fs-2 text-primary" style="width:38px;height:38px;"></i>
        </a>
        <ul class="dropdown-menu shadow rounded-4 glassy-toolbar mt-2" aria-labelledby="userDropdown">
          <li><a class="dropdown-item" href="http://127.0.0.1:8000/user/"><i class="bi bi-person-circle me-2"></i>Hồ sơ</a></li>
          <li><a class="dropdown-item" href="http://127.0.0.1:8000/admin/"><i class="bi bi-gear me-2"></i>Cài đặt</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="http://127.0.0.1:8000/accounts/logout/?next=/accounts/login/"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
        </ul>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <!-- Popup Chú giải -->
  <div id="legend-popup" class="legend-popup shadow rounded-4" style="display:none;position:fixed;top:80px;left:100px;z-index:9999;background:#fff;width:340px;max-height:80vh;overflow:auto;">
    <div class="d-flex align-items-center border-bottom px-3 py-2">
      <span class="fw-bold fs-5 flex-grow-1">CHÚ GIẢI</span>
      <button id="close-legend" class="btn btn-light border-0 fs-4">&times;</button>
    </div>
    <div class="px-3 py-3">
      {% if models %}
      <div id="model-list" class="model-list">
        {% for model in models %}
        <div class="model-item border rounded-3 mb-3 p-2 d-flex flex-column" draggable="true" data-id="{{ model.id }}">
          <div class="d-flex align-items-center justify-content-between mb-1">
            <span class="fw-bold">{{ model.ten }}</span>
            <i class="bi bi-grip-vertical drag-handle" style="cursor:grab;"></i>
          </div>
          <div class="model-desc text-muted mb-2" style="font-size:0.98em;">{{ model.mo_ta }}</div>
          {% with legend=legend_data.model.id %}
            {% if legend and legend.items %}
            <div class="legend-section mt-1">
              <div class="legend-title text-primary fw-semibold mb-1">Chú giải</div>
              <ul class="legend-list list-unstyled mb-0">
                {% for item in legend.items %}
                <li class="d-flex align-items-center gap-2 mb-1">
                  {{ item.icon|safe }} <span class="legend-label small">{{ item.label }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          {% endwith %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="border rounded-3 p-3 text-center text-muted" style="min-height:80px;">Vui lòng chọn lớp dữ liệu!</div>
      {% endif %}
    </div>
  </div>
  <main class="zendenta-main flex-grow-1 px-4 py-4 bg-light position-relative">
    <header class="d-flex align-items-center justify-content-between mb-4 pb-2 border-bottom border-2 gap-3 position-relative">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-bar-chart-steps fs-2 text-primary"></i>
        <h2 class="dashboard-title mb-0 fw-bold">Quản lý mô hình &amp; Bản đồ</h2>
      </div>
      <div class="d-flex align-items-center gap-3 position-relative">
        <button id="notification-btn" class="btn btn-light rounded-circle shadow-sm position-relative me-2" title="Thông báo" style="width:44px;height:44px;">
          <i class="bi bi-bell fs-5 text-primary"></i>
          <span class="position-absolute top-0 end-0 translate-middle badge rounded-pill bg-danger" style="font-size:0.7em;">2</span>
        </button>
        <!-- Popup thông báo -->
        <div id="notification-popup" style="position:fixed; top:70px; right:40px; min-width:320px; z-index:99999; display:none;">
          <div class="card shadow-lg rounded-4 border-0 glassy-toolbar">
            <div class="card-header bg-white rounded-top-4 d-flex align-items-center justify-content-between px-3 py-2">
              <span class="fw-bold text-primary"><i class="bi bi-bell me-2"></i>Thông báo</span>
              <button type="button" class="btn-close" aria-label="Đóng" onclick="document.getElementById('notification-popup').style.display='none';"></button>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item bg-transparent border-0 py-2 px-3">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-info-circle text-primary fs-5"></i>
                  <div>
                    <div class="fw-semibold">Hệ thống cập nhật thành công</div>
                    <div class="small text-muted">1 phút trước</div>
                  </div>
                </div>
              </li>
              <li class="list-group-item bg-transparent border-0 py-2 px-3">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-exclamation-circle text-warning fs-5"></i>
                  <div>
                    <div class="fw-semibold">Có bản đồ mới được thêm</div>
                    <div class="small text-muted">5 phút trước</div>
                  </div>
                </div>
              </li>
              <li class="list-group-item bg-transparent border-0 py-2 px-3">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-check-circle text-success fs-5"></i>
                  <div>
                    <div class="fw-semibold">Bạn đã đăng nhập thành công</div>
                    <div class="small text-muted">10 phút trước</div>
                  </div>
                </div>
              </li>
            </ul>
            <div class="card-footer bg-white rounded-bottom-4 text-center py-2">
              <a href="#" class="text-primary fw-semibold small">Xem tất cả thông báo</a>
            </div>
          </div>
        </div>
        <span class="dashboard-date text-muted fw-medium"><i class="bi bi-calendar2-week me-2"></i>{{ now|date:'d/m/Y' }}</span>
      </div>
<!-- Đã gộp block extra_scripts về cuối file -->
    </header>
      <div class="zendenta-map-wrapper rounded-4 overflow-hidden shadow position-relative">
        <div id="map" class="map-view"></div>
        <!-- Nút zoom nổi trên map -->
        <div class="map-zoom-controls">
          <button id="zoom-in" class="toolbar-btn shadow rounded-circle btn-lg btn btn-outline-primary d-flex align-items-center justify-content-center mb-2" title="Phóng to"><i class="bi bi-plus"></i></button>
          <button id="zoom-out" class="toolbar-btn shadow rounded-circle btn-lg btn btn-outline-primary d-flex align-items-center justify-content-center" title="Thu nhỏ"><i class="bi bi-dash"></i></button>
        </div>
      </div>
      <div class="dashboard-info-panel mt-4">
        <aside id="info-sidebar" class="info-sidebar rounded-4 shadow-lg">
          <div class="popup-form">
            <div class="popup-form-title d-flex align-items-center justify-content-between px-3 pt-3">
              <span class="sidebar-title fw-bold fs-5 text-primary"></span>
              <button class="sidebar-close btn btn-sm btn-light border-0 fs-3" title="Đóng">&times;</button>
            </div>
            <div class="popup-form-desc sidebar-desc px-3"></div>
            <div class="popup-accordion px-3 pb-3">
              <button class="accordion-btn active w-100 mb-2 rounded-3 bg-light text-primary fw-bold shadow-sm">
                <i class="bi bi-table me-2"></i>Bảng Thông Tin <span class="arrow">&#9660;</span>
              </button>
              <div class="accordion-panel" style="display:block;">
                <table class="popup-table sidebar-table table table-bordered table-hover rounded-3"></table>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
    <div id="menu-overlay" class="menu-overlay"></div>
    <!-- Zendenta-style map style menu: glass, shadow, rounded, modern -->
    <div id="map-style-menu" class="map-style-menu rounded-4 shadow-lg p-4 glassy-menu">
      <button id="close-style-menu" class="close-style-menu btn btn-light border-0 fs-2 position-absolute top-0 end-0 m-3">&times;</button>
      <h5 class="fw-bold mb-3 text-primary d-flex align-items-center gap-2" style="font-size:1.25em;"><i class="bi bi-palette2 me-2"></i>Chọn kiểu bản đồ</h5>
      <ul class="style-list list-unstyled d-flex flex-wrap gap-3 mb-3" style="gap:1.2rem 1rem;justify-content:center;">
        <li><button class="style-option btn btn-outline-primary d-flex flex-column align-items-center gap-2 p-2 rounded-4 shadow-sm" data-layer="basic-base"><img src="https://cloud.maptiler.com/static/img/maps/basic-v2.png?t=1755757107" alt="Basic" class="style-thumb rounded-3 shadow-sm" style="width:72px;height:54px;object-fit:cover;"> <span style="font-weight:600;">Basic</span></button></li>
        <li><button class="style-option btn btn-outline-primary d-flex flex-column align-items-center gap-2 p-2 rounded-4 shadow-sm" data-layer="streets-base"><img src="https://cloud.maptiler.com/static/img/maps/streets-v2.png?t=1755757107" alt="Streets" class="style-thumb rounded-3 shadow-sm" style="width:72px;height:54px;object-fit:cover;"> <span style="font-weight:600;">Streets</span></button></li>
        <li><button class="style-option btn btn-outline-primary d-flex flex-column align-items-center gap-2 p-2 rounded-4 shadow-sm" data-layer="satellite-base"><img src="https://cloud.maptiler.com/static/img/maps/satellite.png?t=1755757107" alt="Satellite" class="style-thumb rounded-3 shadow-sm" style="width:72px;height:54px;object-fit:cover;"> <span style="font-weight:600;">Satellite</span></button></li>
        <li><button class="style-option btn btn-outline-primary d-flex flex-column align-items-center gap-2 p-2 rounded-4 shadow-sm" data-layer="topo-base"><img src="https://cloud.maptiler.com/static/img/maps/topo-v2.png?t=1755757107" alt="Topo" class="style-thumb rounded-3 shadow-sm" style="width:72px;height:54px;object-fit:cover;"> <span style="font-weight:600;">Topo</span></button></li>
      </ul>
      <hr style="margin:1.2rem 0;">
      <div class="layer-toggle-group px-1 pb-2" style="font-size:1.08em;">
        <label class="d-block mb-2"><input type="checkbox" id="toggle-diemktnuoc" checked class="form-check-input me-2">Điểm kiểm tra nước dưới đất</label>
        <label class="d-block mb-2"><input type="checkbox" id="toggle-htrg-thuyloi" class="form-check-input me-2">Hệ thống thủy lợi</label>
        <label class="d-block"><input type="checkbox" id="toggle-giaothong" class="form-check-input me-2">Giao thông</label>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/maplibre-gl@5.7.1/dist/maplibre-gl.js"></script>
<script src="{% static 'hello_world/js/main.js' %}"></script>
{% endblock %}